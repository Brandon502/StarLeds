<!DOCTYPE html>
<html>
<head>
    <title>Playground</title>
    <script>
      let ws;
      function gId(c) {return document.getElementById(c);}

      function onLoad() {
        let url = (window.location.protocol == "https:"?"wss":"ws")+'://'+window.location.hostname+'/ws';
        console.log("onLoad url", url);
        ws = new WebSocket(url);
        ws.binaryType = "arraybuffer";
    	  ws.onmessage = (e)=>{
            // console.log("onmessage", e.data);
            let json = JSON.parse(e.data);
            if (json[0].incldef) {
              console.log("onmessage generateHTML", json);
              generateHTML(json);
            }
            else {
              console.log("onmessage updateHTML", json);
              updateHTML(json);
            }
	    }
	    ws.onclose = (e)=>{
            console.log("onclose", e);
	    }
	    ws.onopen = (e)=>{
            console.log("onopen", e);
        }
      }

      function requestJson(command) {
        let url = `http://${window.location.hostname}/json`;
        let req = JSON.stringify(command);

        console.log("requestJson", url, command);

        fetch(url, {
          method: 'post',
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          },
          body: req
        })
        .then(res => {
          if (res) console.log("requestJson res", res);
        })
        .then(json => {
          if (json) console.log("requestJson json", json);
        })
        .catch((e)=>{
          console.log("requestJson catch", e);
        });

        //to be replaced by ws.send();
      }

      function setInput(element) {
        var command = {};
        command[element.id] = element.value
        console.log("setInput", command);

        requestJson(command);
      }
      function setCheckbox(element) {
        var command = {};
        command[element.id] = element.checked
        console.log("setCheckbox", command);

        requestJson(command);
      }

      function generateHTML(json) {
        // console.log("generateHTML", json);
        if (json.length) for (var element of json)
          generateHTML(element);
        if (json.type == "input") {
          gId('in').innerHTML += `<p>${json.prompt}<input id=${json.prompt} oninput="setInput(this)" value="${json.value}"></p>`;
        }
        else if (json.type == "checkbox") {
          gId('in').innerHTML += `<p>${json.prompt}<input id=${json.prompt} type="checkbox" onchange="setCheckbox(this)" ${json.value?"checked":""}></p>`;
        }
      }
      function updateHTML(json) {
        // console.log("updateHTML", json);
        if (json.length) for (var element of json)
          updateHTML(element);
        if (json.type == "input") {
          gId(json.prompt).value = json.value;
        }
        else if (json.type == "checkbox") {
          gId(json.prompt).checked = json.value;
        }
      }
      </script>
</head>
<body onload="onLoad()">
    <p>Hello world</p>
    <div id="in"></div>
</body>
</html>